<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	
        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">
        
	<title>SBCL生成可执行代码的方法</title>
</head>

<body>
	<h2><a href="/">间歇性折腾</a></h2>
	
	<h3>SBCL生成可执行代码的方法</h3>
<p id="meta">16 Mar 2014</p>

<div id="post">
<p>在SBCL中有一个内置函数 save-lisp-and-die 可以将正在运行的整个SBCL环境dump为一个文件。语法：</p>

<pre><code>(save-lisp-and-die &quot;filename&quot; :toplevel 'main  :executable t :compression t)</code></pre>

<p>其中：</p>

<ul>
<li>filename 是导出后的文件名</li>

<li>:toplevel ‘main 指定程序的入口点为 main 函数，并且在程序运行完毕后退出，而不是进入REPL。</li>

<li>:executable t 导出为可执行文件</li>

<li>:compression t 压缩core image，可以大大压缩导出后的文件体积，如果不加这个参数，一个单纯的hello world有将近30M那么大，加上compresson后被压缩到只有9M左右。要使用本参数，需要在编译SBCL时打开开关。我没有尝试过官网的预编译版本，不过可以确定的是Debian仓库中的SBCL是没有打开这个开关的。最后下载了SBCL的源码自己编译解决。</li>
</ul>

<p>具体用法：<a href="http://www.sbcl.org/manual/#Saving-a-Core-Image">http://www.sbcl.org/manual/#Saving-a-Core-Image</a></p>

<p>示例(fib.lisp)：</p>

<pre><code>(defun fib (n)
  (if (&lt; n 2) 1
    (+ (fib (- n 1))
       (fib (- n 2)))))
       
(defun main ()
  (format t &quot;~a~%&quot; (fib 40)))</code></pre>

<p>然后在SBCL中load:</p>

<pre><code>$ sbcl
This is SBCL 1.1.16, an implementation of ANSI Common Lisp.
More information about SBCL is available at &lt;http://www.sbcl.org/&gt;.

SBCL is free software, provided as is, with absolutely no warranty.
It is mostly in the public domain; some portions are provided under
BSD-style licenses.  See the CREDITS and COPYING files in the
distribution for more information.

* (load &quot;fib.lisp&quot;)

T
* (save-lisp-and-die &quot;fib&quot; :toplevel 'main :executable t :compression t)
[undoing binding stack and other enclosing state... done]
[saving current Lisp image into fib:
writing 3528 bytes from the read-only space at 0x0x1000000
compressed 4096 bytes into 1227 at level -1
writing 2272 bytes from the static space at 0x0x1100000
compressed 4096 bytes into 933 at level -1
writing 29634560 bytes from the dynamic space at 0x0x9000000
compressed 29634560 bytes into 9021703 at level -1
done]

ls -l 
-rwxr-xr-x 1 user user 9891868  3月 16 11:05 fib

$ time ./fib
165580141

real    0m5.051s
user    0m4.984s
sys     0m0.048s</code></pre>
</div>
 
</body>
</html>
 